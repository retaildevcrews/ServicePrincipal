### Login to Azure

```bash

az login

###  show your Azure accounts
az account list -o table

###  select the Azure subscription if necessary
az account set -s {subscription name or Id}
```

>All commands require you to be in svc_ppl-automation/infra

### Choose a unique DNS name
```bash
# this will be the prefix for all resources
#  only use a-z and 0-9 - do not include punctuation or uppercase characters
#  must be at least 5 characters long
#  must start with a-z (only lowercase)
export svc_ppl_Name=[your unique name]

### if true, change svc_ppl_Name
az cosmosdb check-name-exists -n ${svc_ppl_Name}

### if nslookup doesn't fail to resolve, change svc_ppl_Name
nslookup ${svc_ppl_Name}.azurewebsites.net
nslookup ${svc_ppl_Name}.vault.azure.net

# TODO no CR for this project yet
# nslookup ${svc_ppl_Name}.azurecr.io 
```

### Set additional values

```bash
# export svc_ppl_Email=replaceWithYourEmail

### change the location (optional)
export svc_ppl_Location=centralus


###  >>>>>>>>>>>>>>>>>>>>>>>>> TODO <<<<<<<<<<<<<<<<<<<<<<<<<<
###  change the repo (optional - valid: test-csharp, test-java, test-typescript)
export svc_ppl_Repo=test-csharp
Deploy serviceprincipal
Make sure you are in the serviceprincipal/infra directory 

### create tfvars file
./create-tf-vars.sh

###  initialize
terraform init

###  validate
terraform validate

###  If you have no errors you can create the resources
terraform apply -auto-approve

###  This generally takes about 10 minutes to complete

```

## Verify the deployment

```bash

# check the App Service
curl https://${svc_ppl_Name}.azurewebsites.net/version
curl https://${svc_ppl_Name}.azurewebsites.net/api/genres

# check the docker logs from the webv tests
az container logs -g ${svc_ppl_Name}-rg-webv -n ${svc_ppl_Name}-webv-${svc_ppl_Location}

# check Log Analytics
export svc_ppl_LogAnalytics_Id='az monitor log-analytics workspace show -g ${svc_ppl_Name}-rg-webv -n ${svc_ppl_Name}-webv-logs --query customerId -o tsv'

az monitor log-analytics query -w $(eval $svc_ppl_LogAnalytics_Id) --analytics-query "ContainerInstanceLog_CL | sort by TimeGenerated"

```

You can also log into the Azure portal and browse the new resources

> If the terraform plan command is redirected to a file, there will be secrets stored in that file!
>
> Be sure not to remove the ignore *tfplan* in the .gitignore file
>

## Module Documentation -- TODO

Each module has a `README` file in the module directory under [`./infra`](./infra). You can reference the module documentation for the specific requirements of each module.

The main calling Terraform script can be found at [`./main.tf`](./main.tf)

Customizations are generated by `create-tf-vars.sh` and stored in `terraform.tfvars`.  This file should never be added to github and is included in the .gitignore file.

## Removing the deployment

>
> WARNING - this will delete everything with only one prompt
>

```bash

# this takes several minutes to run
terraform destroy

# delete the service principals
az ad sp delete --id http://${svc_ppl_Name}-acr-sp
az ad sp delete --id http://${svc_ppl_Name}-tf-sp

# remove state and vars files
rm terraform.tfstate*
rm terraform.tfvars

```

## Contributing

This project welcomes contributions and suggestions. Most contributions require you to agree to a Contributor License Agreement (CLA) declaring that you have the right to, and actually do, grant us the rights to use your contribution. For details, visit [Microsoft Contributor License Agreement](https://cla.opensource.microsoft.com).

When you submit a pull request, a CLA bot will automatically determine whether you need to provide a CLA and decorate the PR appropriately (e.g., status check, comment). Simply follow the instructions provided by the bot. You will only need to do this once across all repos using our CLA.

This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/). For more information see the [Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.
